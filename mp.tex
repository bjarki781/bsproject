\documentclass[openany, a4paper, 11pt, english]{article}
\usepackage[top=3.17cm, bottom=3.27cm, left=3.5cm, right=3.5cm]{geometry}
%\setlength{\parindent}{2.5em}
\setlength{\parskip}{6pt plus 2pt minus 1pt}
{\renewcommand{\arraystretch}{1.3}

\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage{latexsym}
\usepackage{amsmath,amsthm,amssymb,amsfonts}
\usepackage{eucal}
\usepackage[english]{babel}
\usepackage{tikz}
\usepackage{epsfig}
\usepackage{amssymb, graphicx, amsmath, amsthm}
\usepackage{calrsfs}
\usepackage{todonotes}
\usepackage[hidelinks]{hyperref}
\usepackage{bm}
\usepackage{appendix}
\usepackage{multicol}
\usepackage[useregional]{datetime2}
\usepackage{listings}
\usepackage{tikz-cd}

\RequirePackage{graphicx}
\RequirePackage{hyperref}
\newcommand{\parm}{\mathord{\color{black!33}\bullet}}

\newcommand{\breath}{\vspace{6pt plus 2pt minus 1pt}\noindent}

\newcommand{\patternrule}{ \mapsto \!}

\newtheorem{theorem}{Theorem}[section]
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{openproblem}[theorem]{Open Problem}
\newtheorem*{openproblem*}{Open Problem}
\newtheorem{conjecture}[theorem]{Conjecture}

\theoremstyle{definition}
\newtheorem{definition}[theorem]{Definition}
\newtheorem{remark}[theorem]{Remark}
\newtheorem*{remark*}{Remark}
\newtheorem{example}[theorem]{Example}
\newtheorem*{example*}{Example}

\newcommand{\eps}{\epsilon}
\newcommand{\NN}{\mathbb{N}}
\newcommand{\ZZ}{\mathbb{Z}}
\newcommand{\QQ}{\mathbb{Q}}
\newcommand{\etal}{et~al.}
\newcommand{\Sym}{S}
\newcommand{\Pow}{\mathcal{P}}
\newcommand{\Ocal}{\mathcal{O}}
\newcommand{\emptyword}{\varepsilon}
\newcommand{\id}{\mathrm{id}}
\newcommand{\rid}{\overline{\id}}
\newcommand{\from}{\leftarrow}
\newcommand{\eq}{\leftrightarrow}
\newcommand{\eqstar}{\stackrel{*}{\leftrightarrow}}
\newcommand{\tostar}{\stackrel{*}{\to}}
\newcommand{\toplus}{\stackrel{+}{\to}}
\newcommand{\fromstar}{\stackrel{*}{\from}}
\newcommand{\nf}[1]{{#1\!\downarrow}}
\newcommand{\floor}[1]{\lfloor#1\rfloor}
\newcommand{\bracket}[1]{[\mskip1mu #1\mskip1mu]}
\DeclareMathOperator{\olap}{\mathcal{O}}
\DeclareMathOperator{\dom}{dom}
\DeclareMathOperator{\img}{img}
\DeclareMathOperator{\des}{des}
\DeclareMathOperator{\maj}{maj}
\DeclareMathOperator{\len}{len}
\DeclareMathOperator{\shr}{shr}

\begin{document}

\title{Enumerating Hertzsprung equivalence classes defined by partitions of the symmetric group of degree 3}
\author{Bjarki Hartjenstein Gunnarsson}
\date{\today}
\maketitle

\begin{abstract}
    Hertzsprung patterns are permutation patterns in which both positions and
    values are required to be adjacent. Families of equivalences of these
    patterns induce equivalence classes. In this paper we introduce a method
    that allows us, given an equivalence relation, to enumerate these
    equivalence classes. This in turn allows us to determine the Wilf-classes of
    all the set partitions of $\Sym_3$.
    \breath \emph{Keywords}: permutation pattern, pattern-rewriting system
\end{abstract}

\section{Introduction}
Permutation patterns are permutations which we can match with parts of other
permutations, under various constrains, which are formalized by mesh patterns.
\cite{claesson:2011}

Classical permutation patterns do not have any constraints on their matches but then we can
constrain them such that the matches' positions or values must be adjacent.
Hertzsprung patterns constrain both. 

In this demonstration we make pattern matches bold.  Let us treat $132$ as classical
pattern, then we would have the following matches in the permutation $15432$.
\[
    \bm{154}32
\]
\[
    \bm{1}54\bm{32}
\]
We will look again at the same pattern and permutation, but assume that the
pattern match is constrained by positions. Then we have the match
\[
    \bm{154}32.
\]
Again, looking at at the same pattern and permutation, but assume that the
pattern is constrained so that the values must be adjacent we have the following
match:
\[
    \bm{1}54\bm{32}.
\]

Hertzsprung patterns constrain the match so both values and positions must be
adjacent. There is no match for the Hertzsprung pattern $132$ in the example
above but as a showcase, given the pattern $132$ and the permutation $1243$ we
have the Hertzsprung match
\[
    1\bm{243}.
\]

From this point onward, everytime we mention patterns we are speaking about
Hertzsprung patterns.

\subsection{Equivalence, equivalence classes and motivation}
We can look at patterns as being equivalent. We say transposition of each pattern into
the other in a permutation will result in an equivalent permutation. Throughout
this article we represent some equivalent patterns with be a family of sets, signifying
a family of equivalences:
\[
    \{ \{\alpha, \beta, \gamma, \dots \}, \{\lambda, \mu, \nu, \dots \}, \dots
    \}.
\]
This is actually a shorthand for
\[
    \{ \{ \alpha, \beta \}, \{ \alpha, \gamma \}, \dots, \{ \lambda, \mu \}, \{
        \lambda, \nu \}, \dots \}
\]
which we call the canonical form.

A family of equivalences $J$ will induce an equivalence relation which we call $\equiv_J$. We
say $u \pi v \equiv_J u \rho v$ if $\{ \pi, \tau \} \in J$, with $u,v \in \Sym$.

For example, if we say $J = \{ \{ 132, 321 \} \}$ then we consider the patterns $132$ and $321$ to
be equivalent by relation $\equiv_J$. That will, for example, result in
\[
    1\bm{243} \equiv_J 1\bm{432}
\]

An equivalence relation on $\Sym = \cup_{n \geq 1} \Sym_n$ splits each $\Sym_n$
into a set of equivalence classes which we want to enumerate. 

Linton had already made some headway on enumerating equivalence classes the
first two types but the spring of 2021 Claesson published a preprint of his
article that gives a semi-automatic way of enumerating equivalence classes of
the last type.

In this article we will attempt to use Anders method to calculate joint
distributions of as many equivalence classes defined by partitions of $\Sym_3$
as we can.

To enumerate these different equivalence classes this we will introduce
pattern-rewriting systems. They are the only non-automatic part of the method
given by Anders.

\subsection{Pattern-rewriting systems}
A pattern-rewriting system is a subset $R \subset \cup_{n} \Sym_n \times \Sym_n$.
We use the notation $\alpha \patternrule \beta$ for $(\alpha, \beta)$ when referring
to elements of a pattern-rewriting system $R$. 

Juxtaposition of permutations signifies concatenation, so if $\pi=123$ and
$\tau=321$ then $\pi\tau=123654$ with the left argument being unchanged and the
right pushed up.

As for notation, we use the variables $\alpha$ and $\beta$ for whole permutations, 
the variables $\pi$, $\rho$, $\tau$ and $\sigma$ for patterns.
Finally we use the variables $u$ and $v$ for slices of permutations.

We can make this subset induce a \emph{rewrite relation} on $\Sym$ in the following way: We say
$p \to_R q$ for $p, q \in \Sym_k$ if there exists $\alpha \patternrule \beta \in R$ so
we can write $p = u \alpha v$ and $q = u \beta v$, where
$u$ and $v$ are some permutations.  Note that the relation is
length-preserving. For example, if $R = \{123 \patternrule 321\}$, then $1234 \to_R 3214$. 

We denote the domain of $R$ by $\dom(R) = \{\alpha : \alpha \patternrule
\beta \in R\}$. The image of $R$ we in turn write $\img(R) = \{\beta : \alpha
\patternrule \beta \in R\}$. We write the reflexive transitive closure of
$\to_R$ as $\tostar_R$. 

An element $x$ in $\Sym$ is said to be in normal form under the relation $\to_R$
if there is no $y \in \Sym$ so that $x \to_R y$. A relation $\to_R$ is said to be
terminating if there exist no infinite chains $x_0 \to_R x_1 \to_R \cdots$. If
$\to_R$ is terminating then every element has at least one normal form. 

We say a relation is confluent if and only if
$$
    y_1 \fromstar x \tostar y_2 \Longrightarrow 
    \exists z. \  y_1 \tostar z \fromstar y_2.
$$
Intuitively, if $\to_R$ is confluent then that implies that every path we can
take using $\to_R$, from a given permutation, will end up in the same place. 

If a system is both terminating and confluent, then every element has a one and
only one normal form.

\begin{corollary}
    If $R$ is a terminating and confluent pattern-rewriting system, then the set
    of $\dom(R)$-avoiding permutations in $S_n$ is a complete set of
    representatives for $S_n / \equiv_R$, the set of equivalence classes of
    $\equiv_R$.
\end{corollary}

We can derive rewrite relations from a given equivalence relation $\equiv_J$.
The only condition we set on those derived rewrite relations is that their
equivalence closure must be equal to the given equivalence relation.
A set of equivalent pairs of patterns $J$ is equal to the set of rewrites to
either direction. 
\begin{example}
    The equivalence $\{ \{123, 321 \} \}$ induces an equivalence relation which is
    equal to the equivalence closure of the rewrite relation induced by two
    different single-image systems, namely $\{123 \patternrule 321\}$ or $\{321
    \patternrule 123\}$. The same goes for $\{ \{ 132, 312 \} \}$, $\{132 \patternrule
    312\}$ or $\{312 \patternrule 132\}$.

    The equivalence closure of the rewrite relation induced by each of these
    four rewrite systems: $\{123 \patternrule 321, 132 \patternrule 312\}$, $\{123
    \patternrule 321, 312 \patternrule 132\}$, $\{321 \patternrule 123, 132
    \patternrule 312\}$, $\{321 \patternrule 123, 312 \patternrule 132\}$ is
    equal to the equivalence relation induced by $\{ \{ 123, 321 \} \}$.

    So for all of these $R$ we have that $\equiv_J$ is the same as $\equiv_R$.
\end{example}

An element of an canonical family equivalence relation $\{ \alpha, \beta \}$ is
actually equal to the pair $(\alpha, \beta)$ and $(\beta, \alpha)$.
Deriving an pattern-rewriting system from a family of equivalences is in
practice choosing either element of the pair for each element of the canonical
equivalence relation.

So the problem is reduced to generating a terminating and confluent system $R$
given a family of equivalences. We then enumerate $\dom(R)$-avoiding
permutations which is the same thing as enumerating different equivalence
classes.  Section 2 of Claesson's paper provides us with a way to do that.
\cite{claesson:2021}

\subsection{Increasing statistics}
A \emph{statistic} is any function $f : \Sym \to \mathbb{N}$. We call $f$ an increasing
statistic with respect to $R$ if $\alpha \to_R \beta$ implies that $f(\alpha) < f(\beta)$.

\begin{lemma}
    Let $R$ be a pattern-rewriting system. If there exists an increasing
    statistic with respect to $R$, then $\to_R$ is terminating.    
\end{lemma}

\begin{definition}
    Let the statistic $\sum_\tau(\alpha)$ be the sum of the positions of occurrences of
    the pattern $\tau$ in $\alpha$. We call this statistic the sigma statistic
    parameterized by the pattern $\tau$.
    \cite{claesson:2021}.
\end{definition}

Let's take one example from Claesson's paper.
\begin{example}
    Let's look at the equivalence $\{ \{ 12, 21 \} \}$. We can select the system $\{
        21 \to 12 \}$. This relation induced by the system is terminating since the statistic
    $\sum_{12}$ is increasing on the relation. It's not
    confluent though, since $321 \to 231$ and $321 \to 312$. So we add the rule
    $231 \patternrule 312$ to the system. The relation is still terminating and by Lemma
    3.3 in Claesson's paper we also have a confluent system. We then end up with
    the system 
    \[
        \{ 21 \patternrule 12, 231 \patternrule 312 \}
    \]

    By his machinery we find that 
    \[
        \sum_{n \geq 1} \Sym_n(21, 231) = \sum_{m \geq 0} m!(x-x^2)^m
    \]
    which is the joint distribution of the equivalence classes defined by 
    $\{ \{ 12, 21 \} \}$, as found by Stanley CITE.
\end{example}

\section{Finding terminating and confluent systems}
Claesson only found systems corresponding to equivalence relations induced by a
single set of equivalent patterns. We will introduce a method for finding
systems for equivalence relations induced by any number of sets.

\subsection{Share invariance}
Let us begin by generelizing the statistic sigma Anders introduced in his paper.

\begin{definition}
    A sigma statistic parameterized by a set of patterns $\Pi$ is defined as
    $$
        \sum\nolimits_\Pi = \sum_{\pi \in \Pi} \sum\nolimits_{\pi}.
    $$
\end{definition}

We also notice that by definiton of increasing statistic that
$\alpha \to_R \beta$ is equivalent to the statement $u \pi v \to_R u \rho v$
then $f(u \pi v) < f(u \rho v)$.

\begin{lemma}
    Let $R$ be a rewrite system with rules of length $n$. If
    \[
        \pi_j = \rho_j, n-m \leq j \leq n \tag{$\ast\ast$} \  \textnormal{where}
        \ m = \max\nolimits_{\tau \in \img(R)} |\shr(\pi, \tau)|\label{shareinvariance}
    \]
    for each $\pi \patternrule \rho \in R$ then we say each rule is \emph{share
    invariant}, and $\sum_{\img(R)}$ is an increasing statistic with respect to $R$. 
\end{lemma}
\begin{proof}
    Let $\alpha \to_R \beta$. Then there is a rule $\pi \patternrule \rho$ in
    $R$ so that $u \pi v \to_R u \rho v$, where $\alpha = u \pi v$ and $\beta =
    u \rho v$. 

    If elements of $\img(R)$ is fully contained in either $u$ or $v$ then we
    can safely ignore them. If an element (there can only be one) appears in $u\pi$ then
    $u \rho$ will have a higher sigma value. If an element appears in $\pi v$
    then by our condition it will also appear in $\rho v$.
    So
    \[
        \sum\nolimits_{\img(R)}(\alpha) < \sum\nolimits_{\img(R)}(\beta)
    \]
\end{proof}

\begin{corollary}
    Let $R$ be a system that is share invariant. Then $\sum_{\img(R)}$ is an
    increasing statistic for $R$, hence $R$ induces a terminating rewrite relation.
\end{corollary}

We then go through each partition of $\Sym_3$ and look at all the possible
system a partition can generate. We then apply theorem to each of those systems
and weed out those who don't fulfill the theorem's conditions. So for each
partition we are left with a set of systems that are terminating.

Those systems are 154, of 203.

\subsection{Making a terminating system confluent}
Lemma $3.3$ in Anders' paper gives us a convinient test to tell if a system is
confluent. 

We run the following algorithm on a terminating system

\lstset{basicstyle=\footnotesize\ttfamily, frame=single, breaklines=true,
mathescape=true}
\begin{minipage}{\linewidth}
\begin{lstlisting}[title={Confluentize}]
confluentize(sys):
    in: a terminating system, sys
        an set of patterns parameterizing an increasing statistic for sys, ps
    out: a terminating and confluent system or failure

    if sys is confluent then
        return sys

    s := choose shortest diverging cluster in O(R)
    rules := { a -> b | a, b are normal forms of s, $\Delta\sum_{ps}$(a -> b) > 0 }

    if rules = $\emptyset$ then
        return failure

    rule := rule from rules chosen by maximum sigma difference of rule

    return algo(sys + rule)
\end{lstlisting}
\end{minipage}

Let us give some proof that these added rules which make the system confluent do
not make the system non-terminating.
 
We have to make sure that the rule adds images or moves them to the right and does not ruin
occurrences of any of the images present in the source permutation.

\[
\begin{tikzcd}  
    & \mathbf{imgdomdomimg} \arrow[dl] \arrow[dr] & \\
    \mathrm{img}\underline{\mathbf{img}\mathrm{dom}}\mathbf{img} \arrow[bend
    right=30]{rr} & & \mathbf{img}\underline{\mathrm{dom}\mathbf{img}}\mathbf{img}
\end{tikzcd}
\]

We see that the system is still terminating under the original $\img(R)$ as we see
that a confluence rule is also share invariant under $\img(R)$.

\subsection{Symmetries}
We can find some more systems by applying the symmetries of the square. Since we
can write permutations as mesh patterns, we can turn those mesh patterns as we
please and get equivalent patterns. Two patterns turned in the same way make
the same turned clusters. 

\section{Application, result and verification}
We can apply the above mentioned results by testing all rewrite systems of a
family of equivelences for share invariance. If it is share invariant.
We can see there are 9 different Wilf classes of those joint distributions we
generated.

\begin{definition}
    We can give a family of equivalences $J$ a size function which is the same
    as the cardinality of the canonical form of the set of equivalences.

    By this definition $| \{ \{ 123, 321 \}, \{ 312, 231, 213 \} \}| = | \{ \{
    123, 321 \}, \{ 312, 231 \}, \{ 312, 213 \} \} | = 3$, for example.
\end{definition}

Let us collate all the results from Appendix A into a table to show how the
different generating functions are distributed.

The joint distribution is always on the form $\sum_{m \geq 0}m!(x+C(x))^m$ where $C$
is the cluster generating function corresponding to the system.

\begin{center}
\begin{tabular}{c|c|c|c}
    $|J|$ & $C_J(x)$ & count & OEIS seq. \\
    \hline
    0 & $0$ & 1 & A000142 \\
    1 & $-x^3$ & 13 & A212580 \\
    2 & $-2x^3$ & 52 & A212432 \\
    2 & $\frac{-x^3-x^4}{x^2+x+1}$ & 2 & A212581 \\
    3 & $-3x^3$ & 62 & \emph{Not present} \\
    3 & $\frac{-2x^3-2x^4-x^5}{x^2+x+1}$ & 10 & A212433 \\
    4 & $-4x^3$ & 8 & \emph{Not present} \\
    4 & $\frac{-3x^3-3x^4-2x^5}{x^2+x+1}$ & 6 & \emph{Not present}\\
    4 & $\frac{-4x^3-2x^4}{x^2+x+1}$ & 1 & \emph{Not present} \\ 
    \hline
    \hline
    5 & $\frac{-5x^3-3x^4-x^5}{x^2+x+1}$ & 1 & \emph{Not present} \\ 
\end{tabular}
\end{center}

If we parameterize each $C_J$ with it's corresponding $J$ value then we have
three different types of cluster generating functions.

Those types are $C'_J(x) = -|J|x^3$, $C''_J(x) = \frac{-|J|x^3-(|J|-1)x^4-(|J|-2)x^5}{x^2+x+1}$
and $C'''_J(x) = \frac{-|J|x^3-(|J|-2)x^4-(|J|-4)x^5}{x^2+x+1}$

For $C'''$ we only generated one system but Anders did generate a system for
$J = \{\{ 123, 132, 213, 231, 312, 321 \}\}$ which cluster generating function
is also $C'''_J$.

So we see that these partitions of $\Sym_3$ are split into three different types
of Wilf-classes, which we can describe by $C'$, $C''$ and $C'''$ and the size
of the partition.

\subsection{Programming}
There were three small programs written for the project: mp for generating the
systems from the equivalence relations, mp for taking the domain of these
systems and calculating the generating functions and finding if their sequences
were found in the OEIS, and finally tester which calculates the first 6 values
of the sequences manually. mp and tester were written in Haskell and mp in Sage Math. 


\section{Problems, questions and remarks}

Are there any other Wilf classes that appear for partitions on $\Sym_3$?

The share invariance idea does not apply to every type of rewrite system, but we
have other increasing statistics for them. Take the equivalence $\{ \{ 213, 132
\} \}$ for example. Its rewrite systems ${\{ 213 \patternrule 132 \}}$ and ${\{
132 \patternrule 213 \}}$ don't fulfill \eqref{shareinvariance}. When we
apply some symmetries to it, we get $\{ \{ 312, 231 \} \}$ which has the same
problem.

But for $\{ 213 \patternrule 132 \}$ sigma parameterized by $21$ is an
increasing statistic. Anders used that statistic quite a bit in his paper.

Would similar formulas to the $C_n$ appear again when we would
look at $\Sym_4$? Can we justify why we get these patterns?

Can we describe clearly $C_{1,2,3}$ from how patterns in the base system cluster together?
Why do the exact rules used to make the system confluent not seem to matter?

Can we derive a way to create a cluster generating function directly from a
given family of equivalences? Can we create a test which tells us given a family
of equivalences which of $C_1$, $C_2$ and $C_3$ will enumerate the equivalence
classes induced by those family of equivalences?
Can this way be generalized to partitions of $\Sym_n$, for every $n$?

Does there exist an algorithm that makes all systems confluent?

The limitations of Claesson's method lay mainly in the fact that the domain of a
system must be fully reduced for the calculations to work. For instance, we can not use his
method for $\{ \{ 12, 21 \}, \{ 123, 321, 312, 213 \} \}$.

\begin{conjecture}
    If a partition $J$ on $\Sym_n$ has a system that has no non-self-clusters in
    its domain then its cluster generating function is $x^n-|J|x$.
\end{conjecture}

\begin{openproblem}
    Find a terminating statistic for the rest of the equivalence relations
    defined by partitions of $\Sym_3$.
\end{openproblem}

\section*{Acknowledgments}

\bibliographystyle{plain}
\bibliography{mp}

\newgeometry{left=2cm,right=2cm,top=2cm,bottom=2cm}
\begin{appendices}
\section{Terminating and confluent systems}
We categorize the equivalence families/equivalence relations by what their joint
distribition is.
\begin{multicols}{2}
\include{appendix}
\end{multicols}
\end{appendices}

\end{document}
